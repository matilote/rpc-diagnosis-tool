name: Publish Arm64 Image to Docker Registry

on: push
    
jobs:
  arm64_building:
    runs-on: ubuntu-18.04
    name: Build on ARM32
    steps:
    - uses: actions/checkout@v2
    - name: Unshallow fetching
      run: git fetch --unshallow
    - uses: uraimo/run-on-arch-action@v1.0.5
      id: runcmd
      with:
        architecture: armv7
        distribution: stretch
        run: |
          uname -a
          apt-get update && apt-get install docker.io -y
          apt install libsnappy-dev libzstd-dev liblz4-dev zlib1g-dev
          git clone https://github.com/facebook/rocksdb.git
          cd rocksdb/
          git fetch --tags
          latestTag=$(git describe --tags `git rev-list --tags --max-count=1`)
          git checkout $latestTag
          TAG="${latestTag:1}"
          PORTABLE=1 make shared_lib
          strip librocksdb.so.${TAG}
          mv librocksdb.so.${TAG} librocksdb.so
