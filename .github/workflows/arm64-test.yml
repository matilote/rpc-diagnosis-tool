name: arm64 test
on: 
  push:
    branches: 
      - master

jobs:
  armv7_job:
    runs-on: ubuntu-18.04
    name: Build on ARM64 
    steps:
      - uses: actions/checkout@v1.0.0
        with:
          lfs: true
      - uses: uraimo/run-on-arch-action@v1.0.5
        id: runcmd
        with:
          architecture: aarch64
          distribution: ubuntu18.04
          run: |
            uname -a
            apt-get update && apt-get install autoconf libtool git make docker.io binutils -y
            git clone https://github.com/bitcoin-core/secp256k1.git
            cd secp256k1/
            ./autogen.sh
            ./configure --enable-module-recovery --enable-experimental --enable-module-ecdh --enable-shared --with-bignum=no
            make
            strip .libs/libsecp256k1.so
            cd ..
            git clone --recursive https://github.com/NethermindEth/nethermind
            mv secp256k1/.libs/libsecp256k1.so nethermind/src/Nethermind/Nethermind.Secp256k1/runtimes/linux-x64/native/libsecp256k1.so
            cp Dockerfile nethermind/Dockerfile
      - name: Publish to Docker
        uses: elgohr/Publish-Docker-Github-Action@master
        env:
          GIT_COMMIT: $(git log -1 --format=%h)
        with:
          name: nethermindeth/nethermind-arm64
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          build-args: GIT_COMMIT
          workdir: nethermind
          dockerfile: Dockerfile