language: csharp
mono: none
sudo: required
os: osx
dotnet: 3.0.100

addons:
  artifacts:
    # â‹®
    working_dir: rocksdb/librocksdb.dylib

jobs:
  include:
    # - script: dotnet test -c Release src/Nethermind/Ethereum.VM.Test
    #  name: "Ethereum.VM.Test"
    - stage: Nethermind Tests    
      script: 
      - git clone git://github.com/Cyan4973/lz4.git
      - brew install gcc
      - brew install snappy
      - brew install zstd
      - brew install jemalloc
      - make -C lz4/lib
      - cp -L lz4/lib/liblz4.dylib ./liblz4_64.dylib
      - make -C lz4/lib clean
      - CFLAGS="-arch x86_64" CXXFLAGS="-arch x86_64" LDFLAGS="-arch x86_64" make -C lz4/lib
      - lipo -create ./liblz4_64.dylib -output ./liblz4.dylib
      - cp -v ./liblz4.dylib lz4/lib/$(readlink lz4/lib/liblz4.dylib)
      - touch lz4/lib/liblz4
      - make -C lz4/lib install
      - git clone https://github.com/facebook/rocksdb.git
      - cd rocksdb/
      - git fetch --tags
      - latestTag=$(git describe --tags `git rev-list --tags --max-count=1`)
      - latestTag=v6.4.6
      - git checkout $latestTag
      - TAG="${latestTag:1}"
      - sed -i.bak '14s/CXXFLAGS += ${EXTRA_CXXFLAGS}/CXXFLAGS += -w/' Makefile
      - PORTABLE=1 make shared_lib
      - mv librocksdb.${TAG}.dylib librocksdb.dylib
      deploy:
        provider: releases
        api_key:
          secure: "Vm3zdwgKJeia6bGemRMHdAFqICWlZZWUyFLX00k8HvEbOvSa6YWEATXQ+uMC6oQ3C4xqmCVEFHGtqFbYrrKHIzoaqFfKD7r3DXb2UkCy9yN+tFEu4KCs9Kx2uDAkiHOYYyq21Wo5r7U8S0nyqKa27VH1WWCzKPfvHTRFBRLUaJzAXQ1ZOr9ptb0J7TvjIjo4r+SBLIF0zmOStAd0VkeVOHEU6TlCbmCW+TSqsrQrb5AK8YCraRdnpk52EJfS59SCPmpevGyaptwnHopkj5nA89sC2s/UgQgCmLp1Gs/+lljUihxKC7krwyt6WWDDZaN8X3Faylwb7x1DQ48ivdg9SgHkYyHE40RYaQ92Jtz4u934+ZhEkkpylPSVfl3zX8lMU4HroGvcn6JATy9gXUao/hihsb9BwOQYiQrAc4tLfqS3Zg8R55G1WrTPlgyt0JxOMBoKl1jESSng0w+J2Sg+/n3WfCX7i/zFSCMdOMfY42+y9egGb0JPxncn7tQ5epo/D6VkpS+NEAoBGNRIsZjXzcyat1+OjM2OMkgRx7gYmnXe6LFQqZfxnZCOImekoVPAmSRIH8DroxkhypHHnoh0xUUm4SdJ1XWp6mTqpaauCMKnNsUYPNlXnYcNyp4Rh8axUtlOJFxV4vwlgDr7l3szQJxpWfYtK0x7O5uHljZ7Znk="
        file: 'librocksdb.dylib'
        skip_cleanup: true
        on:
          tags: true
      # - brew install snappy
      # - brew install lz4
      # - brew install zstd
      # - brew install gmp
      # - brew install jemalloc
      # - git clone https://github.com/NethermindEth/nethermind --recursive
      # - cd nethermind/src/Nethermind
      # - dotnet build Nethermind.sln -c Release
      # - rm -f /Users/travis/build/matilote/rpc-diagnosis-tool/nethermind/src/Nethermind/Nethermind.Runner/bin/Release/netcoreapp3.0/runtimes/osx-x64/native/librocksdb.dylib
      # - cp /Users/travis/build/matilote/rpc-diagnosis-tool/librocksdb.dylib /Users/travis/build/matilote/rpc-diagnosis-tool/nethermind/src/Nethermind/Nethermind.Runner/bin/Release/netcoreapp3.0/runtimes/osx-x64/native/librocksdb.dylib
      # - cd Nethermind.Runner
      # - dotnet run -c Release --no-build -- --config mainnet